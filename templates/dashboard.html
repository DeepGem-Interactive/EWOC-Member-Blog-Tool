{% extends "base.html" %}

{% block title %}Dashboard - NLBM Blog Tool{% endblock %}

{% block extra_css %}
<style>
    .article-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    /* Article icon styling */
    .article-icon {
        font-size: 1.5rem;
        color: #0E2539;
        margin-bottom: 1rem;
        text-align: left;
    }

    .tone-option {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        transition: all 0.2s;
    }
    .tone-option:hover {
        background-color: #f8f9fa;
    }
    .tone-option.selected {
        border-color: #0E2539;
        background-color: #f0f7ff;
    }

    .keyword-container {
        margin-bottom: 1rem;
    }
    .keyword-badge {
        cursor: pointer;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .selected-keyword {
        background-color: #0d6efd !important;
    }
    .stored-keyword {
        background-color: #6c757d !important;
    }
    .keyword-input-group {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .remove-keyword {
        cursor: pointer;
        margin-left: 0.25rem;
    }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #0E2539;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .filter-btn {
        transition: all 0.2s;
    }
    .filter-btn.active {
        background-color: #0E2539;
        color: white;
        border-color: #0E2539;
    }
    .btn-group {
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .btn-group .btn {
        margin: 0;
    }

    #articles-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
        transition: all 0.3s ease;
    }

    .article-card {
        transition: all 0.3s ease;
        break-inside: avoid;
        margin-bottom: 1rem;
    }

    /* For filtered views */
    .flex-layout {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .flex-layout .article-card {
        flex: 1 1 300px;
        max-width: calc(33.333% - 1rem);
    }

    /* Preview button styles */
    .preview-btn {
        background: none;
        border: none;
        color: var(--nlbm-primary);
        padding: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .preview-btn:hover {
        color: var(--nlbm-secondary);
    }

    .preview-btn i {
        width: 16px;
        height: 16px;
    }

    /* Article header with preview button */
    .article-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    /* Slide-in preview dialog */
    .preview-dialog {
        position: fixed;
        top: 0;
        left: -100%;
        width: 100%;
        max-width: 600px;
        height: 100vh;
        background: white;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        transition: left 0.3s ease-in-out;
        overflow-y: auto;
    }

    .preview-dialog.active {
        left: 0;
    }

    .preview-header {
        padding: 1rem;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: white;
        z-index: 1;
    }

    .preview-content {
        padding: 1.5rem;
    }

    .preview-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
    }

    .preview-overlay.active {
        display: block;
    }

    .close-preview {
        background: none;
        border: none;
        color: var(--nlbm-medium-gray);
        cursor: pointer;
        padding: 8px;
        transition: color 0.2s;
    }

    .close-preview:hover {
        color: var(--nlbm-dark-gray);
    }
</style>
{% endblock %}

{% block content %}
<!-- Add preview dialog -->
<div class="preview-overlay" id="previewOverlay"></div>
<div class="preview-dialog" id="previewDialog">
    <div class="preview-header">
        <h3 class="preview-title mb-0">Article Preview</h3>
        <button class="close-preview" id="closePreview">
            <i data-feather="x"></i>
        </button>
    </div>
    <div class="preview-content" id="previewContent">
        <!-- Content will be loaded here -->
    </div>
</div>

<div class="card shadow-sm">
    <!-- Toast notification -->
    <div class="toast-container">
        <div id="toast" class="toast align-items-center text-white bg-success" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toast-message"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Dashboard header -->
    <div class="card-header bg-white">
        <div class="d-flex flex-column">
            <h1 class="h3 mb-0">Choose an Article to Customize</h1>
            <div class="instructions text-muted">
                <p class="mb-1"><small>
                    
                    Select one of the following PFL articles, your preferred writing tone and keywords to customize for your firm.
                    You can come back to this screen to customize another article after you're done.
                </small></p>
            </div>
        </div>
    </div>

    <!-- Add filter controls -->
    <div class="card-body border-bottom">
        <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
            <span class="me-2">Filter:</span>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary filter-btn active" data-filter="latest">Latest</button>
                <button type="button" class="btn btn-outline-primary filter-btn" data-filter="all">All Articles</button>
            </div>
            {% if series_list %}
            <div class="btn-group" role="group">
                {% for series in series_list %}
                <button type="button" class="btn btn-outline-primary filter-btn" 
                        data-filter="series-{{ loop.index }}"
                        data-series="{{ series }}">
                    {{ series }}
                </button>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Main content area-->
    <div class="card-body">
        {% if articles %}
        <div class="row">
            {% for article in articles %}
            {% set article_index = loop.index %}
            {% set meta = metadata.get(article, {}) %}
            
            <!-- Article card -->
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 article-card"
                    data-series="{{ meta.series if meta.series else 'none' }}"
                    data-series-index="{{ meta.series_order if meta.series_order else 0 }}"
                    data-publish-date="{{ meta.publish_date if meta.publish_date else '' }}">
                    <div class="card-body">
                        <!-- Article header with preview button -->
                        <div class="article-header">
                        <div class="article-icon">
                            <i data-feather="file-text"></i>
                            </div>
                            <button class="preview-btn" data-article="{{ article }}" title="Preview Article">
                                <i data-feather="eye"></i>
                                <span>Preview</span>
                            </button>
                        </div>
                        
                        <!-- Article title -->
                        <h2 class="article-title">
                            {% if meta and meta.title %}{{ meta.title }}{% else %}{{ article }}{% endif %}
                        </h2>
                        
                        <!-- Article description -->
                        {% if meta and meta.description %}
                            <p class="article-description">{{ meta.description }}</p>
                        {% endif %}
                        
                        <!-- Article selection form -->
                        <form method="POST" action="{{ url_for('select_article', article=article) }}" class="mb-3 article-form">
                            <input type="hidden" name="firm" value="{{ user.firm }}">
                            <input type="hidden" name="location" value="{{ user.location }}">
                            <input type="hidden" name="lawyer_name" value="{{ user.lawyer_name }}">
                            <input type="hidden" name="state" value="{{ user.state }}">
                            <input type="hidden" name="address" value="{{ user.address }}">
                            <input type="hidden" name="planning_session" value="{{ user.planning_session }}">
                            <input type="hidden" name="other_planning_session" value="{{ user.other_planning_session }}">
                            <input type="hidden" name="discovery_call_link" value="{{ user.discovery_call_link }}">
                            <button type="submit" class="btn btn-primary w-100">
                                <i data-feather="edit-2" class="icon-sm me-1"></i>Generate Article
                            </button>
                        </form>
                        
                        <!-- Article details preview -->
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <button class="btn btn-link text-decoration-none p-0 d-flex align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#userInfoCollapse" aria-expanded="false" aria-controls="userInfoCollapse">
                                    <i data-feather="chevron-right" class="icon-sm me-2 collapse-icon"></i>
                                    <h3 class="h6 mb-0">Your Information</h3>
                                </button>
                                <button type="button" class="btn btn-sm btn-light border edit-info-btn">
                                    <i data-feather="edit-2" class="icon-sm"></i>
                                </button>
                            </div>
                            <div class="collapse" id="userInfoCollapse">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <!-- View Mode -->
                                        <div class="info-view-mode">
                                            <p class="mb-2"><strong>Firm:</strong> <span class="firm-value">{{ user.firm }}</span></p>
                                            <p class="mb-2"><strong>Location:</strong> <span class="location-value">{{ user.location }}</span></p>
                                            <p class="mb-2"><strong>Lawyer Name:</strong> <span class="lawyer-name-value">{{ user.lawyer_name }}</span></p>
                                            <p class="mb-2"><strong>State:</strong> <span class="state-value">{{ user.state }}</span></p>
                                            {% if user.address %}
                                            <p class="mb-2"><strong>Address:</strong> <span class="address-value">{{ user.address }}</span></p>
                                            {% endif %}
                                            <p class="mb-2"><strong>Planning Session:</strong> <span class="planning-session-value">{{ user.planning_session }}</span></p>
                                            {% if user.other_planning_session %}
                                            <p class="mb-2"><strong>Other Planning Session:</strong> <span class="other-planning-session-value">{{ user.other_planning_session }}</span></p>
                                            {% endif %}
                                            {% if user.discovery_call_link %}
                                            <p class="mb-0"><strong>Discovery Call Link:</strong> <span class="discovery-call-link-value">{{ user.discovery_call_link }}</span></p>
                                            {% endif %}
                            </div>
                            
                                        <!-- Edit Mode -->
                                        <div class="info-edit-mode" style="display: none;">
                                            <div class="mb-2">
                                                <label class="form-label"><strong>Firm:</strong></label>
                                                <input type="text" class="form-control form-control-sm firm-input" value="{{ user.firm }}">
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label"><strong>Location:</strong></label>
                                                <input type="text" class="form-control form-control-sm location-input" value="{{ user.location }}">
                                </div>
                                            <div class="mb-2">
                                                <label class="form-label"><strong>Lawyer Name:</strong></label>
                                                <input type="text" class="form-control form-control-sm lawyer-name-input" value="{{ user.lawyer_name }}">
                                    </div>
                                            <div class="mb-2">
                                                <label class="form-label"><strong>State:</strong></label>
                                                <input type="text" class="form-control form-control-sm state-input" value="{{ user.state }}">
                                </div>
                                            <div class="mb-2">
                                                <label class="form-label"><strong>Address:</strong></label>
                                                <input type="text" class="form-control form-control-sm address-input" value="{{ user.address }}">
                            </div>
                                            <div class="mb-2">
                                                <label class="form-label"><strong>Planning Session:</strong></label>
                                                <input type="text" class="form-control form-control-sm planning-session-input" value="{{ user.planning_session }}">
                                    </div>
                                    <div class="mb-2">
                                                <label class="form-label"><strong>Other Planning Session:</strong></label>
                                                <input type="text" class="form-control form-control-sm other-planning-session-input" value="{{ user.other_planning_session }}">
                                    </div>
                                    <div class="mb-2">
                                                <label class="form-label"><strong>Discovery Call Link:</strong></label>
                                                <input type="text" class="form-control form-control-sm discovery-call-link-input" value="{{ user.discovery_call_link }}">
                                            </div>
                                            <div class="d-flex gap-2 mt-3">
                                                <button type="button" class="btn btn-sm btn-primary save-info-btn">Save Changes</button>
                                                <button type="button" class="btn btn-sm btn-secondary cancel-edit-btn">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}

        <div class="empty-state">
            <i data-feather="folder-x" class="icon-xl"></i>
            <h3 class="h4 mb-3">No Articles Available</h3>
            <p class="text-muted mb-4">Place your DOCX files in the articles/ directory to get started.</p>
            <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
                <i data-feather="refresh-cw" class="icon-sm me-1"></i>Refresh
            </a>
        </div>
        {% endif %}

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="background: rgba(255, 255, 255, 0.9); z-index: 9999;">
            <div class="d-flex flex-column align-items-center justify-content-center h-100">
                <div class="spinner-border spinner-border-sm text-dark mb-2" role="status" style="width: 2rem; height: 2rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="text-dark mb-0">Generating your blog...</h5>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
        
        const toastEl = document.getElementById('toast');
        const toast = toastEl ? new bootstrap.Toast(toastEl, {autohide: true, delay: 3000}) : null;

        // Show loading overlay when form is submitted
        document.querySelectorAll('.article-form').forEach(form => {
            form.addEventListener('submit', function() {
                document.getElementById('loadingOverlay').classList.remove('d-none');
            });
        });

        // Handle collapse icon rotation
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
            button.addEventListener('click', function() {
                const icon = this.querySelector('.collapse-icon');
                if (icon) {
                    icon.style.transform = this.getAttribute('aria-expanded') === 'true' ? 'rotate(90deg)' : 'rotate(0deg)';
                }
            });
        });

        // Edit information functionality
        document.querySelectorAll('.edit-info-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Toggle button appearance
                this.classList.toggle('btn-light');
                this.classList.toggle('btn-primary');
                
                // Ensure the collapse is open when editing
                const collapse = this.closest('.mt-3').querySelector('#userInfoCollapse');
                if (collapse) {
                    const bsCollapse = new bootstrap.Collapse(collapse, {toggle: false});
                    bsCollapse.show();
                }

                const card = this.closest('.card-body');
                const viewMode = card.querySelector('.info-view-mode');
                const editMode = card.querySelector('.info-edit-mode');
                
                // Set form values to current view values
                const setValue = (viewSelector, editSelector) => {
                    const viewElement = viewMode.querySelector(viewSelector);
                    const editElement = editMode.querySelector(editSelector);
                    if (viewElement && editElement) {
                        editElement.value = viewElement.textContent;
                    }
                };

                // Set values with null checks
                setValue('.firm-value', '.firm-input');
                setValue('.location-value', '.location-input');
                setValue('.lawyer-name-value', '.lawyer-name-input');
                setValue('.state-value', '.state-input');
                setValue('.address-value', '.address-input');
                setValue('.planning-session-value', '.planning-session-input');
                setValue('.other-planning-session-value', '.other-planning-session-input');
                setValue('.discovery-call-link-value', '.discovery-call-link-input');
                
                // Show edit mode
                viewMode.style.display = 'none';
                editMode.style.display = 'block';
            });
        });
        
        document.querySelectorAll('.cancel-edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const card = this.closest('.card-body');
                const viewMode = card.querySelector('.info-view-mode');
                const editMode = card.querySelector('.info-edit-mode');
                
                // Reset edit button appearance
                const editBtn = card.closest('.mt-3').querySelector('.edit-info-btn');
                editBtn.classList.remove('btn-primary');
                editBtn.classList.add('btn-light');
                
                // Hide edit mode and show view mode
                editMode.style.display = 'none';
                viewMode.style.display = 'block';
            });
        });
        
        document.querySelectorAll('.save-info-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const card = this.closest('.card-body');
                const viewMode = card.querySelector('.info-view-mode');
                const editMode = card.querySelector('.info-edit-mode');
                
                // Reset edit button appearance
                const editBtn = card.closest('.mt-3').querySelector('.edit-info-btn');
                editBtn.classList.remove('btn-primary');
                editBtn.classList.add('btn-light');
                
                // Helper function to update values
                const updateValue = (viewSelector, editSelector) => {
                    const viewElement = viewMode.querySelector(viewSelector);
                    const editElement = editMode.querySelector(editSelector);
                    if (viewElement && editElement) {
                        viewElement.textContent = editElement.value;
                    }
                };

                // Update view mode values
                updateValue('.firm-value', '.firm-input');
                updateValue('.location-value', '.location-input');
                updateValue('.lawyer-name-value', '.lawyer-name-input');
                updateValue('.state-value', '.state-input');
                updateValue('.address-value', '.address-input');
                updateValue('.planning-session-value', '.planning-session-input');
                updateValue('.other-planning-session-value', '.other-planning-session-input');
                updateValue('.discovery-call-link-value', '.discovery-call-link-input');

                // Update hidden inputs in the article form
                const articleForm = card.closest('.article-card').querySelector('.article-form');
                if (articleForm) {
                    const updateFormValue = (name, editSelector) => {
                        const input = articleForm.querySelector(`input[name="${name}"]`);
                        const editElement = editMode.querySelector(editSelector);
                        if (input && editElement) {
                            input.value = editElement.value;
                        }
                    };

                    updateFormValue('firm', '.firm-input');
                    updateFormValue('location', '.location-input');
                    updateFormValue('lawyer_name', '.lawyer-name-input');
                    updateFormValue('state', '.state-input');
                    updateFormValue('address', '.address-input');
                    updateFormValue('planning_session', '.planning-session-input');
                    updateFormValue('other_planning_session', '.other-planning-session-input');
                    updateFormValue('discovery_call_link', '.discovery-call-link-input');
                }

                // Switch back to view mode
                editMode.style.display = 'none';
                viewMode.style.display = 'block';

                // Show success message
                if (toast) {
                    document.getElementById('toast-message').textContent = 'Information updated successfully!';
                    toast.show();
                }
            });
        });
    
        // Filter button click handler
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Update active state
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const filterType = this.dataset.filter;
                filterArticles(filterType, this);
            });
        });

        // Initialize with 'latest' filter
            const defaultFilter = document.querySelector('.filter-btn[data-filter="latest"]');
            if (defaultFilter) defaultFilter.click();

        function filterArticles(filterType, clickedButton) {
            const articlesContainer = document.querySelector('.row');
            const articles = Array.from(document.querySelectorAll('.article-card'));
            
            // First, reset all articles to visible and remove any previous hiding
            articles.forEach(article => {
                article.style.display = 'block';
                article.parentElement.style.display = 'block';
            });
            
            if (filterType === 'latest') {
                // Object to track the highest series_order article for each series
                const latestSeriesArticles = {};
                
                // First pass - find the article with highest series_order for each series
                articles.forEach(article => {
                    const series = article.dataset.series;
                    const seriesOrder = parseInt(article.dataset.seriesIndex) || 0;
                    
                    if (series !== 'none') {
                        if (!latestSeriesArticles[series] || 
                            seriesOrder > latestSeriesArticles[series].order) {
                            latestSeriesArticles[series] = {
                                element: article,
                                order: seriesOrder
                            };
                        }
                    }
                });
                
                // Second pass - hide non-latest series articles
                articles.forEach(article => {
                    const series = article.dataset.series;
                    
                    if (series === 'none') {
                        // Non-series article - always show
                        article.style.display = 'block';
                        article.parentElement.style.display = 'block';
                    } else {
                        // Series article - show only if it has the highest series_order
                        if (latestSeriesArticles[series] && article === latestSeriesArticles[series].element) {
                            article.style.display = 'block';
                            article.parentElement.style.display = 'block';
                        } else {
                            article.style.display = 'none';
                            article.parentElement.style.display = 'none';
                        }
                    }
                });
            }
            else if (filterType === 'all') {
                // Show all articles - already handled by the initial reset
            }
            else if (filterType.startsWith('series-')) {
                // Show only articles from the selected series
                const targetSeries = clickedButton.dataset.series;
                
                articles.forEach(article => {
                    if (article.dataset.series === targetSeries) {
                        article.style.display = 'block';
                        article.parentElement.style.display = 'block';
                    } else {
                        article.style.display = 'none';
                        article.parentElement.style.display = 'none';
                    }
                });
            }
            
            // Force reflow to trigger any CSS transitions
            void articlesContainer.offsetWidth;
        }
        
        // Preview functionality
        const previewDialog = document.getElementById('previewDialog');
        const previewOverlay = document.getElementById('previewOverlay');
        const previewContent = document.getElementById('previewContent');
        const closePreview = document.getElementById('closePreview');

        // Function to load article content
        async function loadArticleContent(article) {
            try {
                const response = await fetch(`/preview_article/${article}`);
                if (!response.ok) throw new Error('Failed to load article');
                const data = await response.json();
                previewContent.innerHTML = data.content;
                feather.replace();
            } catch (error) {
                console.error('Error loading article:', error);
                previewContent.innerHTML = '<div class="alert alert-danger">Failed to load article preview</div>';
            }
        }

        // Open preview
        document.querySelectorAll('.preview-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const article = this.dataset.article;
                loadArticleContent(article);
                previewDialog.classList.add('active');
                previewOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
        });

        // Close preview
        function closePreviewDialog() {
            previewDialog.classList.remove('active');
            previewOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        closePreview.addEventListener('click', closePreviewDialog);
        previewOverlay.addEventListener('click', closePreviewDialog);

        // Close on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && previewDialog.classList.contains('active')) {
                closePreviewDialog();
            }
        });
    });
</script>
{% endblock %}